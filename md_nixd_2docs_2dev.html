<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nixd: Developers&#39; Manual</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">nixd
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Developers' Manual</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md13"></a> </p>
<h2><a class="anchor" id="autotoc_md14"></a>
First place to make diff</h2>
<p>See our "issues" page. And some issues are marked with <a href="https://github.com/nix-community/nixd/issues?q=is%3Aissue+label%3A%22good+first+issue%22+is%3Aopen">good first issue</a>. Such issues are intentially left for new contributors. i.e. main developers usasually won't touch them, and there are some detailed instructions about how to do.</p>
<p>Please comment on that issue so that it can be assigned to you, to avoid any duplicated work in the community.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Hack nixd from source</h2>
<p>Clone this project and <code>cd</code> into the cloned repoistory.</p>
<p>Enter the development shell, using</p>
<div class="fragment"><div class="line">nix develop</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Tip: use <code>direnv</code> &amp; the vscode extension (direnv) + clangd, gives you IDE experience in vsocde Write <code>echo "use flake" &gt;&gt; .envrc</code> should be sufficient for basic setup. </p>
</blockquote>
<p>Then configure the project, using meson.</p><ul>
<li><code>--buildtype=debug</code> is suitable for most developers.</li>
<li><code>--prefix=</code> is used for non-privileged installation[^prefix-ignore].</li>
<li><code>--default-library=static</code> enable static linking for <code>libnixf</code>, <code>libnixt</code>, ... thus you can avoid RPATH issues in custom installation prefix.</li>
<li><code>-Dwerror=true</code> to make sure you can pass nixd CI (we enable Werror in testing env).</li>
</ul>
<p>[^prefix-ignore]: after the installation, your worktree is tidy. A trick to resolve this is: <code>echo "local" &gt;&gt; .git/info/exclude</code>.</p>
<div class="fragment"><div class="line">meson setup build --buildtype=debug --default-library=static --prefix=$PWD/local/install -Dwarning_level=3 -Dwerror=true</div>
</div><!-- fragment --><p>Finally, invoke</p>
<div class="fragment"><div class="line">meson compile -C build</div>
</div><!-- fragment --><p>And</p>
<div class="fragment"><div class="line">ninja -C build install</div>
</div><!-- fragment --><p>Then you can lauch an editor to quick test nixd, under <code>local/install/bin</code>.</p>
<blockquote class="doxtable">
<p>&zwj;[!WARNING] <code>nixd</code> cannot be properly launched from "build" directory (i.e. it requires installation for editor testing). </p>
</blockquote>
<p>To run unit/regression test, invoke:</p>
<div class="fragment"><div class="line">ninja -C build test</div>
</div><!-- fragment --><p>Remember to make sure unit/regression tests are passing before submiting PRs!</p>
<p>Happy hacking!</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Design</h2>
<h3><a class="anchor" id="autotoc_md17"></a>
Memory model about nix language &amp; nixd workers</h3>
<p><b>TLDR: Evaluation is not memory-safe and must be performed in a separeted address space.</b></p>
<p>In the context of the Nix language, laziness refers to the evaluation strategy where expressions are not immediately evaluated when they are encountered, but rather when their values are actually needed. This means that the evaluation of an expression is deferred until it is required to produce a result.</p>
<p>One consequence of lazy evaluation is the potential for circular references or circular dependencies.</p>
<p>Our upstream <a href="https://github.com/NixOS/nix">C++ nix</a> uses a garbage collector and never actively free used memories. Thus all evaluators should be used in "worker" processes.</p>
<div class="fragment"><div class="line">┌─────────────────┐</div>
<div class="line">│   Controller    │ ─┐</div>
<div class="line">└─────────────────┘  │</div>
<div class="line">  ▲                  │</div>
<div class="line">  │                  │</div>
<div class="line">  │ JSON RPC         │</div>
<div class="line">  ▼                  │</div>
<div class="line">┌─────────────────┐  │</div>
<div class="line">│     Worker      │  │</div>
<div class="line">└─────────────────┘  │</div>
<div class="line">  │                  │</div>
<div class="line">  │                  │</div>
<div class="line">  ▼                  │</div>
<div class="line">┌─────────────────┐  │</div>
<div class="line">│ Workspace Files │ ◀┘</div>
<div class="line">└─────────────────┘</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
Testing</h2>
<p>This project is tested by "unit tests" and "regression tests".</p>
<p>Regression tests are written in <b>markdown</b>, and directly execute the compiled binary. Unit tests are used for testing class interfaces, mostly public methods.</p>
<p>Nixd regression tests could be found at <a href="/tools/nixd/test/">here</a>.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Contributing</h2>
<p>Our git history is semi-linear. That is, firstly we rebase a branch on the top of the mainline, then merge it with <code>--no-ff</code>.</p>
<p>Our continuous integration systems will enable several <b>sanitizer</b> options to detect data race and undefined behavior in our codebase.</p>
<p>Please add or modify tests for your changed files (with all branches coveraged) and ensure that all tests can pass with sanitizers enabled.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Commit message</h3>
<p>Commit messages are formatted with:</p>
<div class="fragment"><div class="line">&lt;subsystem-name&gt;: brief message that talks about what you changed</div>
</div><!-- fragment --><p>This is not strict for contributors, feel free to write your own stuff. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
